<!DOCTYPE html>
<html ng-app="exampleApp">
	<head>
		<title>Forms</title>
		<script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
		<script>
			var app = angular.module("exampleApp", []).controller("defaultCtrl", function ($scope) {

			$scope.data = [
					{id : 0, name : "Mauricio1", nick : "koitoer", description : "desc1", nick2 : "reotiok"},
					{id : 1, name : "Mauricio", nick : "shipto", description : "desc1", nick2 : "reotipk"}
				 ];
				 
			}).directive("editableRow", function () {
				return{
				    
					restrict: 'A',
					
					scope : {
						item : '='
					},
					
					link: function (scope, elem, attrs) {
						
						var editButton = angular.element(elem[0].querySelector('.edit-button'));
						var cancelButton = angular.element(elem[0].querySelector('.cancel-button'));
						var saveButton = angular.element(elem[0].querySelector('.save-button'));
						
						/**
						* Code for Edit feature, will change the DOM for editable components.
						*/
						editButton.on("click", function (e) {
							var childs = elem.children();
							for (var i = 1; i < childs.length - 1; i++){
							
								var keyCode = angular.element(childs[i]).attr("e-value");
								var regexExp = angular.element(childs[i]).attr("e-regex");
								var currentTr = angular.element(childs[i]);
								
								
								if(currentTr.hasClass("editable-text") || currentTr.hasClass("editable-textArea")){
									angular.element(currentTr).children().addClass("hidden");
									var value = scope.item[keyCode.trim()];
								}
							
								 if(angular.element(childs[i]).hasClass("editable-text")){
									angular.element(childs[i]).append('<input type="text" value="'+value+'" ng-model = {{value}}/>');
								 }
								
								if(angular.element(childs[i]).hasClass("editable-textArea")){
									angular.element(childs[i]).append('<textarea rows="4" cols="50"> '+value+'</textarea>');
								 }
								 
								cancelButton.toggleClass("hidden");
								saveButton.toggleClass("hidden");
								editButton.addClass("hidden");
								 
							}
						});
						
						
						/**
						* Code for Cancel feature, will change the DOM for editable components removing them
						*/
						cancelButton.on("click", function (e) {
						
							var childs = elem.children();
							for (var i = 1; i < childs.length - 1; i++){
							
								var currentTr = angular.element(childs[i]);
								
								 if(currentTr.hasClass("editable-text") || currentTr.hasClass("editable-textArea")){
									angular.element(currentTr.children()).toggleClass("hidden");
									angular.element(currentTr.children()[1]).remove();			
								 }
						
								editButton.toggleClass("hidden");
								saveButton.toggleClass("hidden");
								cancelButton.addClass("hidden");
							}
						});
						
						
						/**
						* Code for Save feature, update the model and create ajax call
						*/
						saveButton.on("click", function (e) {
						
							var childs = elem.children();
							for (var i = 1; i < childs.length - 1; i++){
								
								var currentTr = angular.element(childs[i]);
							
								if(currentTr.hasClass("editable-text") || currentTr.hasClass("editable-textArea")){
									currentTr.children().toggleClass("hidden");
									var newValue = currentTr.children()[1].value;
									var keyCode = currentTr.attr("e-value");
									console.log("Index : " + i + " -> " + keyCode + " : " + newValue);
									scope.item[keyCode.trim()] =  newValue;
									scope.$apply();
									currentTr.children()[1].remove();
								}
								
								
							}
							
							editButton.toggleClass("hidden");
							cancelButton.toggleClass("hidden");
							$(this).addClass("hidden");
							
						});
						
					}
				}
			});
		</script>
	</head>

	<body ng-controller="defaultCtrl">
		<div id="todoPanel" class="panel" >
			<table class="table">
		  <thead>
			   <tr>
					<th>Index</th>
					<th>Name</th>
					<th>NickName</th>
					<th>Description</th>
					<th>NickName2</th>
					<th>edit</th>
					<th>save</th>
			   </tr>
		  </thead>	 
		  <tbody>
			   <tr editable-row ng-repeat = "person in data" item ="person" url=$%$6>
					<td>{{$index}}</td>
					<td>{{person.name}}</td>
					<td class = "editable-text" e-value="nick" e-regex=""><span ng-bind="person.nick"></span></td>
					<td class = "editable-textArea" e-value="description" e-regex=""><span ng-bind="person.description"></span></td>
					<td class = "editable-text" e-value="nick2" e-regex=""><span>{{person.nick2}}</span></td>
					<td>
						<button type="button" class="btn btn-primary edit-button" >Edit</button>
						<button type="button" class="btn btn-success save-button hidden">Save</button>
					</td>
					<td>
						
						<button type="button" class="btn btn-danger cancel-button hidden">Cancel</button>
					</td>
				</tr>
		  </tbody>
		</table>
		</div>
		
		{{data}}
		
		<div id="todoPanel" class="panel">
			<table class="table">
		  <thead>
			   <tr>
					<th>Index</th>
					<th>Name</th>
					<th>NickName</th>
					<th>Description</th>
					<th>NickName2</th>
					<th>edit</th>
					<th>save</th>
			   </tr>
		  </thead>	 
		   <tbody>
			   <tr editable-row ng-repeat = "person in data" item ="person" url=$%$6>
					<td>{{$index}}</td>
					<td>{{person.name}}</td>
					<td class = "editable-text" e-value="nick" e-regex=""><span ng-bind="person.nick"></span></td>
					<td class = "editable-textArea" e-value="description" e-regex=""><span ng-bind="person.description"></span></td>
					<td class = "editable-text" e-value="nick2" e-regex=""><span>{{person.nick2}}</span></td>
					<td>
						<button type="button" class="btn btn-primary edit-button" >Edit</button>
						<button type="button" class="btn btn-success save-button hidden">Save</button>
					</td>
					<td>
						
						<button type="button" class="btn btn-danger cancel-button hidden">Cancel</button>
					</td>
				</tr>
		  </tbody>
		</table>
		</div>

	</body>
</html>
